@page "/get-wallet"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Options
@using OpenPrismNode.Core.Common
@using OpenPrismNode.Web.Models

@attribute [Authorize(Roles = "User,Admin")]

@inject IHttpClientFactory HttpClientFactory
@inject IHttpContextAccessor HttpContextAccessor
@inject IOptions<AppSettings> AppSettingsOptions

@rendermode @(new InteractiveServerRenderMode(prerender: false))

<div class="mx-auto mt-4 p-4 border rounded shadow-sm space-y-4">
    <h3 class="text-xl font-semibold text-center">Get Wallet</h3>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="text-red-600 text-center">@ErrorMessage</div>
    }

    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="text-green-600 text-center">@SuccessMessage</div>
    }

    <div>
        <label class="block text-gray-700 font-semibold mb-1">Wallet ID</label>
        <input class="border w-full px-2 py-1 rounded"
               @bind="WalletId"
               placeholder="Enter wallet ID..." />
    </div>

    <div class="flex justify-end">
        <button class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                @onclick="LoadWallet">
            Load Wallet
        </button>
    </div>

    @if (LoadedWallet is not null)
    {
        <div class="p-2 border rounded bg-gray-50 mt-2 space-y-1">
            <div><strong>Wallet ID:</strong> @LoadedWallet.WalletId</div>
            <div><strong>Balance:</strong> @LoadedWallet.Balance</div>
            <div><strong>Funding Address:</strong> @LoadedWallet.FundingAddress</div>
            <div><strong>Syncing Complete:</strong> @(LoadedWallet.SyncingComplete ? "Yes" : "No")</div>
            <div><strong>Sync Progress:</strong> @LoadedWallet.SyncProgress</div>
        </div>
    }
</div>

@code {
    private HttpClient? _httpClient;
    private string WalletId { get; set; } = string.Empty;

    private string ErrorMessage { get; set; } = string.Empty;
    private string SuccessMessage { get; set; } = string.Empty;

    private GetWalletResponseModel? LoadedWallet;

    protected override void OnInitialized()
    {
        _httpClient = HttpClientFactory.CreateClient("LocalApi");
        var request = HttpContextAccessor.HttpContext?.Request;

        if (request is not null)
        {
            var baseUrl = $"{request.Scheme}://{request.Host}";
            _httpClient.BaseAddress = new Uri(baseUrl);

            var cookie = HttpContextAccessor.HttpContext.Request.Headers["Cookie"];
            if (!string.IsNullOrEmpty(cookie))
            {
                if (_httpClient.DefaultRequestHeaders.Contains("Cookie"))
                {
                    _httpClient.DefaultRequestHeaders.Remove("Cookie");
                }
                _httpClient.DefaultRequestHeaders.Add("Cookie", cookie.ToString());
            }
        }
    }

    private async Task LoadWallet()
    {
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
        LoadedWallet = null;

        if (string.IsNullOrWhiteSpace(WalletId))
        {
            ErrorMessage = "Please enter a wallet ID.";
            return;
        }

        try
        {
            var response = await _httpClient!.GetAsync($"api/v1.0/wallets/{WalletId}");
            if (!response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                ErrorMessage = $"Failed to load wallet: {content} (HTTP {response.StatusCode})";
                return;
            }

            LoadedWallet = await response.Content.ReadFromJsonAsync<GetWalletResponseModel>();
            SuccessMessage = "Wallet loaded successfully!";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading wallet: {ex.Message}";
        }
    }

}
